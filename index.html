<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>線上測驗系統</title>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 900px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .header { text-align: center; margin-bottom: 20px; }
        .question-list { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
        .question-btn { padding: 10px 15px; border: 1px solid #ccc; border-radius: 5px; cursor: pointer; background: #eee; text-decoration: none; color: #333; }
        .question-btn.answered { background-color: #d4edda; border-color: #c3e6cb; }
        .quiz-section h2 { margin-top: 0; }
        .options div { margin: 10px 0; }
        .options input, .options textarea { margin-right: 10px; }
        .ranking-list { list-style: none; padding: 0; }
        .ranking-list li { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }
        #submit-btn { padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        #login-form { text-align: center; }
        #login-form input { padding: 8px; margin-top: 10px; border-radius: 5px; border: 1px solid #ccc; }
        #login-form button { padding: 8px 15px; border: none; background-color: #28a745; color: white; border-radius: 5px; cursor: pointer; }
        .nav-buttons button { margin-right: 10px; padding: 8px 15px; border: none; background-color: #6c757d; color: white; border-radius: 5px; cursor: pointer; }
        #attempts-info { font-size: 0.9em; color: #666; margin-top: 10px; }
        .font-size-controls { text-align: right; margin-bottom: 10px; }
        .font-size-controls button { padding: 5px 10px; cursor: pointer; border: 1px solid #ccc; background: #f9f9f9; border-radius: 4px; }
        .font-size-controls button.active { background-color: #007bff; color: white; }
        /* 新增的載入中畫面樣式 */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 1000;
            display: none; /* 預設隱藏 */
        }
        #loading-overlay p { font-size: 20px; font-weight: bold; }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <p>載入中...請稍後</p>
    </div>

    <div class="container">
        <div class="font-size-controls">
            <button onclick="setFontSize('small')">小</button>
            <button onclick="setFontSize('medium')" class="active">中</button>
            <button onclick="setFontSize('large')">大</button>
        </div>

        <div class="header" id="welcome-section">
            <h1>歡迎使用測驗系統！</h1>
            <p>請輸入你的名稱以開始作答。</p>
            <form id="login-form">
                <input type="text" id="username-input" placeholder="你的名稱" required>
                <button type="submit">進入測驗</button>
            </form>
        </div>

        <div id="main-quiz-section" style="display: none;">
            <div class="nav-buttons">
                <button id="show-questions-btn">回到題目列表</button>
                <button id="show-ranking-btn">查看排名</button>
            </div>

            <div id="questions-view">
                <h2>題目列表</h2>
                <div class="question-list" id="question-list-container"></div>
            </div>

            <div id="quiz-view" style="display: none;">
                <h2 id="question-title"></h2>
                <div class="options" id="options-container"></div>
                <div id="attempts-info"></div>
                <button id="submit-btn">提交答案</button>
            </div>
            
            <div id="ranking-view" style="display: none;">
                <h2>即時排名</h2>
                <ul class="ranking-list" id="ranking-container"></ul>
            </div>
        </div>
    </div>

    <script>
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzkhhV9y6iHlWY14V4ucYNqNkkYJ5LAbfi8nEhF9vX7E8O-rs05P5d4qfnh47QibyFx/exec";

        let questions = [];
        let username = '';
        let userStatus = { responses: {}, attempts: {}, totalScore: 0 };
        let currentQuestion = null;
        
        const welcomeSection = document.getElementById('welcome-section');
        const mainQuizSection = document.getElementById('main-quiz-section');
        const loginForm = document.getElementById('login-form');
        const usernameInput = document.getElementById('username-input');

        const questionsView = document.getElementById('questions-view');
        const quizView = document.getElementById('quiz-view');
        const rankingView = document.getElementById('ranking-view');

        const questionListContainer = document.getElementById('question-list-container');
        const questionTitle = document.getElementById('question-title');
        const optionsContainer = document.getElementById('options-container');
        const attemptsInfo = document.getElementById('attempts-info');
        const submitBtn = document.getElementById('submit-btn');

        const rankingContainer = document.getElementById('ranking-container');
        const showQuestionsBtn = document.getElementById('show-questions-btn');
        const showRankingBtn = document.getElementById('show-ranking-btn');

        const loadingOverlay = document.getElementById('loading-overlay'); // 載入畫面元素

        loginForm.addEventListener('submit', function(e) {
            e.preventDefault();
            username = usernameInput.value;
            if (username) {
                welcomeSection.style.display = 'none';
                mainQuizSection.style.display = 'block';
                showLoading();
                loadUserStatus().then(() => {
                    loadQuestions();
                }).finally(hideLoading);
            }
        });
        
        showQuestionsBtn.addEventListener('click', showQuestionsList);
        showRankingBtn.addEventListener('click', () => {
            showLoading();
            showRanking().finally(hideLoading);
        });
        submitBtn.addEventListener('click', () => {
            showLoading();
            submitAnswer().finally(hideLoading);
        });

        // 顯示載入畫面
        function showLoading() {
            loadingOverlay.style.display = 'flex';
        }
        
        // 隱藏載入畫面
        function hideLoading() {
            loadingOverlay.style.display = 'none';
        }

        function showQuestionsList() {
            quizView.style.display = 'none';
            rankingView.style.display = 'none';
            questionsView.style.display = 'block';
            renderQuestionList();
        }

        function showRanking() {
            questionsView.style.display = 'none';
            quizView.style.display = 'none';
            rankingView.style.display = 'block';
            return fetchRanking();
        }

        function setFontSize(size) {
            document.querySelectorAll('.font-size-controls button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.font-size-controls button[onclick="setFontSize('${size}')"]`).classList.add('active');
            
            const root = document.documentElement;
            if (size === 'small') {
                root.style.fontSize = '14px';
            } else if (